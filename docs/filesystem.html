<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Filesystem - Rotko Networks infrastructure</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = null;
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="hardware.html"><strong aria-hidden="true">2.</strong> Hardware</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="rack.html"><strong aria-hidden="true">2.1.</strong> Rack</a></li><li class="chapter-item expanded "><a href="networking_hw.html"><strong aria-hidden="true">2.2.</strong> Networking</a></li><li class="chapter-item expanded "><a href="firmware.html"><strong aria-hidden="true">2.3.</strong> Firmware</a></li><li class="chapter-item expanded "><a href="bkk01.html"><strong aria-hidden="true">2.4.</strong> BKK01</a></li><li class="chapter-item expanded "><a href="bkk02.html"><strong aria-hidden="true">2.5.</strong> BKK02</a></li><li class="chapter-item expanded "><a href="bkk03.html"><strong aria-hidden="true">2.6.</strong> BKK03</a></li><li class="chapter-item expanded "><a href="bkk04.html"><strong aria-hidden="true">2.7.</strong> BKK04</a></li><li class="chapter-item expanded "><a href="carbon.html"><strong aria-hidden="true">2.8.</strong> Carbon offset</a></li></ol></li><li class="chapter-item expanded "><a href="software.html"><strong aria-hidden="true">3.</strong> Software</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="networking_sw.html"><strong aria-hidden="true">3.1.</strong> Networking</a></li><li class="chapter-item expanded "><a href="filesystem.html" class="active"><strong aria-hidden="true">3.2.</strong> Filesystem</a></li><li class="chapter-item expanded "><a href="ansible.html"><strong aria-hidden="true">3.3.</strong> Ansible</a></li><li class="chapter-item expanded "><a href="virtualization.html"><strong aria-hidden="true">3.4.</strong> Virtualization</a></li></ol></li><li class="chapter-item expanded "><a href="team.html"><strong aria-hidden="true">4.</strong> Team</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Rotko Networks infrastructure</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="filesystem"><a class="header" href="#filesystem">Filesystem</a></h1>
<p>The file system is perhaps the most underappreciated component in the
blockchain synchronization process, despite being pivotal. It's puzzling how
little attention this crucial element receives. Try seeking a single article
discussing the ideal record sizes for blockchain databases - you'll quickly
discover the dearth of literature on this subject. By offloading additional
tasks to the application users, we inadvertently make chains more difficult to
synchronize, an outcome that inadvertently centralizes those running the nodes.</p>
<p>Upon rigorous testing of various file systems - including mdraid (ext4), LVM,
mdraid, Btrfs, and ZFS - our findings suggest that ZFS stands out as the most
user-friendly and well-rounded solution. While LVM and Btrfs also has its
merits, its user interface tooling design seems to be more suitable for those
with a high tolerance for complexity.</p>
<h2 id="zfs"><a class="header" href="#zfs">ZFS</a></h2>
<p>ZFS offers incredibly easy client tool to use for setting up complex filesystem
setup with snapshots and quota management.</p>
<h3 id="installation"><a class="header" href="#installation">Installation</a></h3>
<p>execute as sudo on debian12/bookworm</p>
<pre><code class="language-bash">#!/bin/bash

# Create the backports file
echo &quot;deb http://deb.debian.org/debian bookworm-backports main contrib
deb-src http://deb.debian.org/debian bookworm-backports main contrib&quot; &gt; /etc/apt/sources.list.d/bookworm-backports.list

# Create the preferences file
echo &quot;Package: src:zfs-linux
Pin: release n=bookworm-backports
Pin-Priority: 990&quot; &gt; /etc/apt/preferences.d/90_zfs

# Update package lists
apt update

# Install necessary packages
apt install -y dpkg-dev linux-headers-$(uname -r) linux-image-$(uname -r)

# Set the environment variable DEBIAN_FRONTEND to noninteractive
# Install ZFS packages
DEBIAN_FRONTEND=noninteractive apt install -y zfs-dkms zfsutils-linux

# Verify the ZFS installation
modprobe zfs &amp;&amp; echo &quot;ZFS installed successfully&quot; || echo &quot;ZFS installation failed&quot;
</code></pre>
<h3 id="zfs-partitioning"><a class="header" href="#zfs-partitioning">ZFS partitioning</a></h3>
<pre><code class="language-bash">#!/bin/bash
# bkk03 zfs setup

# Array of disks to be used
disks=(&quot;nvme1n1&quot; &quot;nvme2n1&quot; &quot;nvme3n1&quot; &quot;nvme4n1&quot;)

# Size of the swap partition on each disk
swap_size=&quot;16G&quot;

# Create swap partition and ZFS partition on each disk
for disk in &quot;${disks[@]}&quot;; do
    echo &quot;Creating partitions on /dev/${disk}&quot;
    
    # Create the swap partition
    parted -s /dev/${disk} mklabel gpt
    parted -s /dev/${disk} mkpart primary linux-swap 1MiB ${swap_size}
    mkswap /dev/${disk}p1
    swap_uuid=$(blkid -s UUID -o value /dev/${disk}p1)

    # Add the swap partitions to /etc/fstab so they're used on startup
    echo &quot;UUID=${swap_uuid} none swap sw 0 0&quot; &gt;&gt; /etc/fstab

    # Enable the swap partition
    echo &quot;Enabling swap on /dev/${disk}p1&quot;
    swapon /dev/${disk}p1

    # Create the ZFS partition
    parted -s /dev/${disk} mkpart primary ${swap_size} 100%

    # Inform the OS of partition table changes
    partprobe /dev/${disk}
done

</code></pre>
<h3 id="zfs-optimized-for-blockchain"><a class="header" href="#zfs-optimized-for-blockchain">ZFS optimized for blockchain</a></h3>
<pre><code class="language-bash"># Now, create the ZFS pool with the remaining space
# TODO: add disk with  root installation to pool as well
disks=(&quot;nvme1n1&quot; &quot;nvme2n1&quot; &quot;nvme3n1&quot; &quot;nvme4n1&quot;)
zpool create -o ashift=12 tank $(for disk in &quot;${disks[@]}&quot;; do echo &quot;/dev/${disk}p2&quot;; done)

# Disable access time (atime) as it can negatively impact performance
zfs set atime=off tank
# Set recordsize to 16K as most values in the ParityDb are small and values over 16K are rare
zfs set recordsize=16k tank
# throughput safer than latency
zfs set logbias=throughput tank
# Set the primary cache to only metadata, as ParityDb relies on the OS page cache
zfs set primarycache=metadata tank
# Enable compression as it can provide both space and performance benefits
zfs set compression=lz4 tank
# Set redundant metadata to most to protect against data corruption
zfs set redundant_metadata=most tank
# Synchronous writes (sync) should be set to standard to ensure data integrity in case of an unexpected shutdown
zfs set sync=standard tank
# Enable snapshots for better data protection
zfs snapshot tank@daily

echo &quot;Finished setting up ZFS pool and swap partitions&quot;
</code></pre>
<p>bkk03 lsblk:</p>
<pre><code class="language-bash">NAME        MAJ:MIN RM   SIZE RO TYPE MOUNTPOINTS
sda           8:0    1  28.7G  0 disk
├─sda1        8:1    1   1.9G  0 part /boot/efi
├─sda2        8:2    1   1.9G  0 part /boot
└─sda3        8:3    1  24.9G  0 part /media/user/489b6b9f-f615-4270-b2c9-9565b9516c00
nvme1n1     259:0    0   1.9T  0 disk
├─nvme1n1p2 259:7    0   1.8T  0 part
└─nvme1n1p1 259:8    0  14.9G  0 part [SWAP]
nvme2n1     259:1    0   1.9T  0 disk
├─nvme2n1p1 259:10   0  14.9G  0 part [SWAP]
└─nvme2n1p2 259:11   0   1.8T  0 part
nvme3n1     259:2    0   1.9T  0 disk
├─nvme3n1p1 259:12   0  14.9G  0 part [SWAP]
└─nvme3n1p2 259:13   0   1.8T  0 part
nvme4n1     259:3    0   1.9T  0 disk
├─nvme4n1p1 259:14   0  14.9G  0 part [SWAP]
└─nvme4n1p2 259:15   0   1.8T  0 part
nvme0n1     259:4    0   1.9T  0 disk
├─nvme0n1p1 259:5    0  59.6G  0 part [SWAP]
├─nvme0n1p2 259:6    0 126.7G  0 part /
└─nvme0n1p3 259:9    0   1.7T  0 part
</code></pre>
<h3 id="blockchains-on-hdd"><a class="header" href="#blockchains-on-hdd">Blockchains on HDD</a></h3>
<p>The NVMe drives themselves should provide high performance and low latency for
your ZFS pool, and a separate ZIL or L2ARC might not provide significant
benefits and could even add unnecessary complexity or costs. You can create
tank/slog and tank/L2ARC for performant read and write cache to reach
&quot;balanced disk&quot; like boosted performance. ZIL ~8GB and L2ARC ~128GB.
This can make huge difference in HDD capability of synchronizing Blockchains
when data is first written in NVMe.</p>
<p>We are using HDD purely for storing snapshots as backups due to using striping
raid for our NVMe:s.</p>
<p>Notice that if you running EVM blockchain with small blocks like Ethereum, it might 
be best option to set your recordsize 4K instead before starting syncing.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="networking_sw.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="ansible.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="networking_sw.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="ansible.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
